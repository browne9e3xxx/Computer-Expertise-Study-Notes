
### 本章要点：
- 运输层的概述
- 端口与通信
- UDP协议
- TCP 协议概述
- 可靠通信概述
- TCP的格式
- TCP如何实现可靠传输
- TCP的流量控制
- TCP的拥塞控制
- TCP的运输连接管理
### 1. 运输层协议概述：
##### 1.1 进程之间的通信：

>1. 运输层向它上面的应用层提供通信服务。
>2. 主机之间的通信实际上是主机之间进程的通信
>3. 应用层把应用层报文交付给运输层。
>4. 网络层为主机之间的通信提供服务，为运输层则在网络层的基础上，为应用进程之间的通信提供服务。![[Pasted image 20240625131112.png]]
>5. 运输层还要对收到的报文进行差错检测


##### 1.2 运输层的两个主要协议：
![[Pasted image 20240625131503.png]]
> 1. TCP：面向连接的服务。唉传输数据之前必须先建立连接，在数据传输之后再释放连接。提供可靠的信息交付。
> 2. UDP：不需要提前建立连接，不提供可靠交付。

##### 1.3 运输层的端口：
>1. 运输层的分用和复用功能：应用层的所有应用进程都可以通过运输层再传输给网络层，这就是==复用==。运输层从IP层收到应用进程的数据后，家付给指明的各应用程序，这就是分用。
>2. 端口：在应用层和运输层之间的界面上，设置一个特殊的抽象的“门”。每一个端口用一个端口号表示。
>3. 当应用层要发送数据时，应用进程就把数据发送到适当的端口，然后运输层从该端口读取数据，进行后续的处理。
>4. 由此可见，两个进程要进行通信，不仅要知道对方的IP地址，还要知道对方的端口号。

运输层的端口号可以分为以下两大类：
> 1. 服务器端使用的端口号：
> 又分两类：
-  熟知端口号（全球通用端口号）：这些端口号指派一些重要的应用程序：![[Pasted image 20240625132609.png]]
-  登记端口号：数值从1024-49151，在IANA按照手续登记。
>2.客户端使用的端口号： 数值49152-65535，由客户进程运行时动态选择，使用完就收回。


 区别：客户端的端口只是用来区分不同进程的，而服务器的端口却是用来给每一个进程具体分配一个固定的端口号。

### 2. 用户数据报协议UDP
##### 2.1 UDP概述：

>UDP在IP数据报的基础上增加三个功能：  
- 复用
- 分用
- 差错检测


>UDP的特点：
- 无连接 
- 尽最大努力交付
- 面向报文
![[Pasted image 20240625134841.png]]
- 没有拥塞控制
- 支持一对一、一对多、多对一、多对多的交互通信
- 首部开销小：只有8个字节

> UDP通信和端口的关系：
> ![[Pasted image 20240625135121.png]]

##### 2.2 UDP的首部格式：
![[Pasted image 20240625135251.png]]


补充一点：一般在应用层的时候，已经知道了目的IP地址。
>首部检验和计算：
>     1. 在计算时添加上伪首部，UDP的首部检验是把首部和数据部分一起检验。
>     2. 首先，先把全零字节放入检验和
>     3. 然后把伪首部和UDP数据报看成是许多16位（不够的填0）的字串接起来，然后求和，再求反，位数直接相反。
>     4. eg：![[Pasted image 20240625141156.png]]


### 3. 传输协议TCP概述：

##### 3.1  TCP协议最主要的特点：
- 面向连接的运输层协议：应用程序在使用TCP协议之前必须先建立TCP连接
- 每一条TCP连接必须是两个端点，点对点连接
- 提供可靠交付服务
- 全双工通信
- 面向字节流：虽然应用程序和TCP的交互是一次一个数据块，但是TCP把应用程序交下来的仅仅看做是一连无结构的字节流
##### 3.2 TCP的连接：
> 1. TCP连接的两个端点是套接字（socket)
> 2. 套接字：端口号拼接到IP地址
> ![[Pasted image 20240625155603.png]]
> 3. 每一条TCP连接唯一地被通信两端的两个端点所确定。![[Pasted image 20240625155656.png]]
> 4. 同一个IP地址可以有多个不同的TCP连接，同一个端口号也可以出现在多个TCP连接中。
> 5. ![[Pasted image 20240625160309.png]]


### 4. 可靠传输的工作原理：

> 理想的传输条件特点：

-  传输信道不产生差错
-  不管发送方以多快的速度发送数据，接收方都能来得及接收。


然而实际的网络不具备这两个条件，我们可以采取一些协议俩尽量满足：

##### 4.1 停止等待协议：
主要有以下几种情况：
###### 1.  无差错情况：

![[Pasted image 20240625160704.png]]
A向B发送数据，发送一个等待B发回一个确认，收到确认后继续发送下一个。

###### 2.  出现差错：
 比如：B未收到，B收到但是错误地丢弃了数据，
> 1. 我们设置了一个超时计时器，当A超过了一段时间没有收到就再次向B发送一个原来的副本。如果在规定时间内收到就将计时器归零。
> 2. A在发送玩一个分组时，必须暂时保存已发送的分组。
> 3. 分组和确认的那组都必须编号。
> 4. 超时重传时间应该比平均往返时间更长一些


###### 3. 确认丢失和确认迟到：
有的时候，B收到了A的报文，但是B向A发送的确认报文可能会丢失或者迟到。

> 1. 这时，B如果重复收到这个报文，就把这个报文丢到。
> 2. 然后B向A再次发送确认
> 3. A如果收到重复的确认报文直接就丢掉。
![[Pasted image 20240625161630.png]]

这种可靠传输协议是：自动重传请求协议ARQ

###### 4.信道利用率：
停止等待协议的缺点就是信道利用率过低。
![[Pasted image 20240625162418.png]]

为了提高信道利用率，我们将采用流水线传输的方法：ARQ协议和==滑动窗口协议==（TCP的精髓所在）

##### 4.2连续ARQ协议：

![[Pasted image 20240625163403.png]]
接收方一般是采用累计确认的方式，只对按需到达的最后一个分组发送确认。

### 5.TCP报文的首部格式
![[Pasted image 20240625163548.png]]

- TCP报文的前20个字节是固定的。
- 源端口和目的端口：各占2字节
- 序号：4字节，做mod 2的32次方，TCP连接中传输的每一个字节都按序编号。报文段序号。
- 确认号：4字节，是期望收到对方下一个报文段的第一个数据字节的序号。![[Pasted image 20240625164026.png]]
- 数据偏移：占4位，单位是32位字，也可以被称为首部长度，用于指明tcp数据部分的位置。
- 保留，占6位，尚未使用，全为0。
- 六个控制位：各占一位.![[Pasted image 20240625164752.png]]
- 窗口：占2字节，指的是发送报文段的一方的接受窗口，告诉对方，接收方目前允许对付那个大送的数据量，以字节为单位。也是在动态的变化着。
- 检验和：与UDP的一样，需要加上伪首部，但是应该把伪首部的第四个类型字段改为6
- 紧急指针：只有子啊URG=1时才有意义。
- 选项：长度可变，最大40字节。最后的填充字段仅仅是为了长度是四字节的整数倍。
- 现在选项又增加了：窗口扩大、时间戳、确认选择等选项。

### 6. TCP可靠传输的实现：
##### 6.1 以字节为单位的滑动窗口

